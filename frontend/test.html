<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GTM Tracking Configuration Wizard</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .wizard-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 700px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Header */
        .gtm-header {
            display: flex;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f2f5;
        }

        .gtm-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4285f4, #34a853);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
            margin-right: 16px;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .gtm-title {
            color: #202124;
            font-size: 28px;
            font-weight: 600;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 40px;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 20px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e8eaed;
            color: #5f6368;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .step-circle.active {
            background: #4285f4;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }

        .step-circle.completed {
            background: #34a853;
            color: white;
        }

        .step-circle.completed::after {
            content: 'âœ“';
            font-size: 18px;
        }

        .step-label {
            font-size: 14px;
            color: #5f6368;
            text-align: center;
            font-weight: 500;
        }

        .step-label.active {
            color: #4285f4;
            font-weight: 600;
        }

        /* Progress line */
        .progress-line {
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e8eaed;
            z-index: 1;
        }

        .progress-fill {
            height: 100%;
            background: #34a853;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Step Content */
        .step {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            color: #202124;
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #5f6368;
            font-size: 16px;
            margin-bottom: 32px;
            line-height: 1.5;
        }

        /* Form Elements */
        label {
            display: block;
            color: #3c4043;
            font-weight: 600;
            margin-bottom: 12px;
            font-size: 16px;
        }

        select, input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #dadce0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            color: #3c4043;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 4px rgba(66, 133, 244, 0.1);
        }

        select:hover, input:hover {
            border-color: #4285f4;
        }

        /* Destination Cards */
        .destination-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 32px 0;
        }

        .destination-card {
            border: 2px solid #dadce0;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .destination-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
            transition: all 0.3s ease;
        }

        .destination-card:hover {
            border-color: #4285f4;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .destination-card.selected {
            border-color: #4285f4;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 133, 244, 0.2);
        }

        .destination-card.selected::before {
            background: #4285f4;
        }

        .destination-card input[type="checkbox"] {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 24px;
            height: 24px;
            accent-color: #4285f4;
        }

        .destination-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 16px;
            transition: transform 0.3s ease;
        }

        .destination-card:hover .destination-icon {
            transform: scale(1.1);
        }

        .destination-name {
            font-size: 18px;
            font-weight: 600;
            color: #202124;
            margin-bottom: 8px;
        }

        .destination-desc {
            font-size: 14px;
            color: #5f6368;
            line-height: 1.4;
        }

        /* Platform specific colors */
        .destination-card[data-destination="ga4"] .destination-icon {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
        }

        .destination-card[data-destination="meta"] .destination-icon {
            background: linear-gradient(135deg, #1877f2, #42a5f5);
            color: white;
        }

        .destination-card[data-destination="tiktok"] .destination-icon {
            background: #000;
            color: white;
        }

        .destination-card[data-destination="linkedin"] .destination-icon {
            background: #0077b5;
            color: white;
        }

        .destination-card[data-destination="snapchat"] .destination-icon {
            background: linear-gradient(135deg, #fffc00, #ffb300);
            color: #333;
        }

        /* ID Configuration */
        .id-configs {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin: 32px 0;
        }

        .config-section {
            background: white;
            border: 2px solid #e8eaed;
            border-radius: 16px;
            padding: 24px;
            position: relative;
            transition: all 0.3s ease;
        }

        .config-section:hover {
            border-color: #4285f4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .config-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .config-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 16px;
            color: white;
        }

        .config-title {
            color: #202124;
            font-size: 20px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group:last-child {
            margin-bottom: 0;
        }

        /* Buttons */
        .buttons {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 40px;
        }

        button {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4285f4, #3367d6);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 133, 244, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #3c4043;
            border: 2px solid #dadce0;
        }

        .btn-secondary:hover {
            background: #f8f9fa;
            border-color: #4285f4;
        }

        .btn-primary:disabled {
            background: #dadce0;
            color: #5f6368;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Loading and Results */
        .loading {
            text-align: center;
            padding: 60px 0;
        }

        .spinner {
            border: 4px solid #e8eaed;
            border-top: 4px solid #4285f4;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #5f6368;
            font-size: 18px;
            font-weight: 500;
        }

        .error {
            background: linear-gradient(135deg, #fce8e6, #f8d7da);
            border: 2px solid #f28b82;
            color: #d93025;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-weight: 500;
        }

        .success-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #e8f5e8, #d1e7dd);
            color: #137333;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .success-badge::before {
            content: 'âœ“';
            margin-right: 8px;
            font-size: 18px;
        }

        /* Preview Section */
        .preview-container {
            background: #f8f9fa;
            border: 2px solid #e8eaed;
            border-radius: 16px;
            padding: 24px;
            margin: 32px 0;
            max-height: 300px;
            overflow-y: auto;
        }

        .preview-content {
            background: #202124;
            color: #e8eaed;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
        }

        .final-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-top: 32px;
        }

        .action-card {
            border: 2px solid #dadce0;
            border-radius: 16px;
            padding: 32px 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            background: white;
        }

        .action-card:hover {
            border-color: #4285f4;
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        }

        .action-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f8f9fa, #e8eaed);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 20px;
            color: #4285f4;
            transition: transform 0.3s ease;
        }

        .action-card:hover .action-icon {
            transform: scale(1.1);
        }

        .action-title {
            font-size: 18px;
            font-weight: 600;
            color: #202124;
            margin-bottom: 8px;
        }

        .action-desc {
            font-size: 14px;
            color: #5f6368;
            line-height: 1.4;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .wizard-container {
                padding: 24px;
            }

            .final-actions {
                grid-template-columns: 1fr;
            }

            .destination-grid {
                grid-template-columns: 1fr;
            }

            .buttons {
                flex-direction: column;
            }

            .progress-steps {
                overflow-x: auto;
                padding-bottom: 10px;
            }

            .step-label {
                font-size: 12px;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <div class="gtm-header">
            <div class="gtm-logo">GTM</div>
            <div class="gtm-title">Tag Configuration Wizard</div>
        </div>

        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-line">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-step">
                    <div class="step-circle active" id="circle1">1</div>
                    <div class="step-label active" id="label1">Goal</div>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="circle2">2</div>
                    <div class="step-label" id="label2">Platforms</div>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="circle3">3</div>
                    <div class="step-label" id="label3">Configure</div>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="circle4">4</div>
                    <div class="step-label" id="label4">Create</div>
                </div>
                <div class="progress-step">
                    <div class="step-circle" id="circle5">5</div>
                    <div class="step-label" id="label5">Deploy</div>
                </div>
            </div>
        </div>

        <!-- Step 1: Tracking Goal -->
        <div class="step active" id="step1">
            <h1>Select Tracking Goal</h1>
            <p class="subtitle">Choose the type of tracking you want to implement with Google Tag Manager</p>
            
            <label for="trackingGoal">What would you like to track?</label>
            <select id="trackingGoal">
                <option value="">Choose your tracking objective...</option>
                <option value="ecommerce">E-commerce Events Tracking</option>
                <option value="leads">Lead Generation Tracking</option>
                <option value="engagement">User Engagement Tracking</option>
                <option value="conversions">Conversion Tracking</option>
            </select>

            <div class="buttons">
                <div></div>
                <button class="btn-primary" onclick="nextStep()" id="step1Next" disabled>Continue</button>
            </div>
        </div>

        <!-- Step 2: Select Destinations -->
        <div class="step" id="step2">
            <h1>Select Platforms</h1>
            <p class="subtitle">Choose which advertising platforms you want to send your tracking data to</p>

            <div class="destination-grid">
                <div class="destination-card" data-destination="ga4">
                    <input type="checkbox" id="ga4" value="ga4">
                    <div class="destination-icon">ðŸ“Š</div>
                    <div class="destination-name">Google Analytics 4</div>
                    <div class="destination-desc">Enhanced ecommerce and conversion tracking</div>
                </div>
                <div class="destination-card" data-destination="meta">
                    <input type="checkbox" id="meta" value="meta">
                    <div class="destination-icon">ðŸ“˜</div>
                    <div class="destination-name">Meta Pixel</div>
                    <div class="destination-desc">Facebook & Instagram advertising pixel integration</div>
                </div>
                <div class="destination-card" data-destination="tiktok">
                    <input type="checkbox" id="tiktok" value="tiktok">
                    <div class="destination-icon">ðŸŽµ</div>
                    <div class="destination-name">TikTok Pixel</div>
                    <div class="destination-desc">Track conversions and build audiences for TikTok Ads</div>
                </div>
                <div class="destination-card" data-destination="linkedin">
                    <input type="checkbox" id="linkedin" value="linkedin">
                    <div class="destination-icon">ðŸ’¼</div>
                    <div class="destination-name">LinkedIn Insight</div>
                    <div class="destination-desc">Professional audience tracking and B2B conversions</div>
                </div>
                <div class="destination-card" data-destination="snapchat">
                    <input type="checkbox" id="snapchat" value="snapchat">
                    <div class="destination-icon">ðŸ‘»</div>
                    <div class="destination-name">Snapchat Pixel</div>
                    <div class="destination-desc">Track conversions and build audiences for Snapchat Ads</div>
                </div>
            </div>

            <div class="buttons">
                <button class="btn-secondary" onclick="prevStep()">Back</button>
                <button class="btn-primary" onclick="nextStep()" id="step2Next" disabled>Continue</button>
            </div>
        </div>

        <!-- Step 3: Configure IDs -->
        <div class="step" id="step3">
            <h1>Configure Tags</h1>
            <p class="subtitle">Enter the required IDs and tokens for your selected platforms</p>

            <div class="id-configs" id="idInputs">
                <!-- Dynamic content will be inserted here -->
            </div>

            <div class="buttons">
                <button class="btn-secondary" onclick="prevStep()">Back</button>
                <button class="btn-primary" onclick="nextStep()" id="step3Next" disabled>Continue</button>
            </div>
        </div>

        <!-- Step 4: Create Configuration -->
        <div class="step" id="step4">
            <h1>Create Configuration</h1>
            <p class="subtitle">Review your settings and generate the GTM configuration</p>

            <div id="configSummary">
                <!-- Summary will be populated here -->
            </div>

            <div class="buttons">
                <button class="btn-secondary" onclick="prevStep()">Back</button>
                <button class="btn-primary" onclick="createConfiguration()" id="step4Next">Create Configuration</button>
            </div>
        </div>

        <!-- Step 5: Deploy -->
        <div class="step" id="step5">
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <div class="loading-text">Generating your GTM configuration...</div>
            </div>

            <div class="error" id="errorMessage" style="display: none;"></div>

            <div id="successContent" style="display: none;">
                <div class="success-badge">Configuration Created Successfully</div>
                <h1>Deploy Your Tags</h1>
                <p class="subtitle">Your tracking configuration is ready. Preview and deploy it.</p>

                <div class="preview-container">
                    <h3 style="margin-bottom: 16px; color: #202124;">Configuration Preview</h3>
                    <div class="preview-content" id="configPreview"></div>
                </div>

                <div class="final-actions">
                    <div class="action-card" onclick="downloadJSON()">
                        <div class="action-icon">ðŸ“„</div>
                        <div class="action-title">Download JSON</div>
                        <div class="action-desc">Export configuration file for manual GTM import</div>
                    </div>
                    <div class="action-card" onclick="integrateWithGTM()">
                        <div class="action-icon">ðŸš€</div>
                        <div class="action-title">Integrate with GTM</div>
                        <div class="action-desc">Directly integrate with Google Tag Manager</div>
                    </div>
                </div>

                <div class="buttons">
                    <button class="btn-secondary" onclick="resetWizard()">Start New Configuration</button>
                    <div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentStep = 1;
        let formData = {
            trackingGoal: '',
            destinations: [],
            pixels: {}
        };
        let configResponse = null;

        // Platform requirements
        const platformRequirements = {
            ga4: {
                name: 'Google Analytics 4',
                icon: 'ðŸ“Š',
                fields: [{ name: 'Measurement ID', placeholder: 'G-XXXXXXXXXX' }]
            },
            meta: {
                name: 'Meta Pixel',
                icon: 'ðŸ“˜',
                fields: [{ name: 'Pixel ID', placeholder: 'Facebook Pixel ID' }]
            },
            tiktok: {
                name: 'TikTok Pixel',
                icon: 'ðŸŽµ',
                fields: [{ name: 'Pixel ID', placeholder: 'TikTok Pixel ID' }]
            },
            linkedin: {
                name: 'LinkedIn Insight Tag',
                icon: 'ðŸ’¼',
                fields: [{ name: 'Partner ID', placeholder: 'LinkedIn Partner ID' }]
            },
            snapchat: {
                name: 'Snapchat Pixel',
                icon: 'ðŸ‘»',
                fields: [{ name: 'Pixel ID', placeholder: 'Snapchat Pixel ID' }]
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateProgressBar();
        });

        function setupEventListeners() {
            // Step 1 - Tracking Goal
            document.getElementById('trackingGoal').addEventListener('change', function() {
                formData.trackingGoal = this.value;
                document.getElementById('step1Next').disabled = !this.value;
            });

            // Step 2 - Destination cards
            document.querySelectorAll('.destination-card').forEach(card => {
                card.addEventListener('click', function() {
                    const checkbox = this.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    toggleDestination(checkbox.value, checkbox.checked);
                    updateDestinationUI();
                });

                const checkbox = card.querySelector('input[type="checkbox"]');
                checkbox.addEventListener('change', function(e) {
                    e.stopPropagation();
                    toggleDestination(this.value, this.checked);
                    updateDestinationUI();
                });
            });
        }

        function toggleDestination(destination, selected) {
            if (selected) {
                if (!formData.destinations.includes(destination)) {
                    formData.destinations.push(destination);
                }
            } else {
                formData.destinations = formData.destinations.filter(d => d !== destination);
            }
        }

        function updateDestinationUI() {
            document.querySelectorAll('.destination-card').forEach(card => {
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (checkbox.checked) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });

            document.getElementById('step2Next').disabled = formData.destinations.length === 0;
        }

        function generateIdInputs() {
            const container = document.getElementById('idInputs');
            container.innerHTML = '';

            formData.destinations.forEach(dest => {
                const config = platformRequirements[dest];
                const section = document.createElement('div');
                section.className = 'config-section';

                let inputsHTML = `
                    <div class="config-header">
                        <div class="config-icon" style="background: ${getIconBackground(dest)}">${config.icon}</div>
                        <div class="config-title">${config.name}</div>
                    </div>
                `;

                config.fields.forEach(field => {
                    const fieldId = `${dest}_${field.name.replace(/\s+/g, '_').toLowerCase()}`;
                    inputsHTML += `
                        <div class="input-group">
                            <label for="${fieldId}">${field.name}</label>
                            <input type="text" id="${fieldId}" data-destination="${dest}" 
                                   data-field="${field.name}" placeholder="${field.placeholder}">
                        </div>
                    `;
                });

                section.innerHTML = inputsHTML;
                container.appendChild(section);
            });

            // Add event listeners
            container.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', validateStep3);
            });
        }

        function getIconBackground(dest) {
            const backgrounds = {
                ga4: 'linear-gradient(135deg, #4285f4, #34a853)',
                meta: 'linear-gradient(135deg, #1877f2, #42a5f5)',
                tiktok: '#000',
                linkedin: '#0077b5',
                snapchat: 'linear-gradient(135deg, #fffc00, #ffb300)'
            };
            return backgrounds[dest] || '#4285f4';
        }

        function validateStep3() {
            const inputs = document.querySelectorAll('#idInputs input');
            const allFilled = Array.from(inputs).every(input => input.value.trim() !== '');
            document.getElementById('step3Next').disabled = !allFilled;
        }

        function collectIdData() {
            const inputs = document.querySelectorAll('#idInputs input');
            formData.pixels = {};

            inputs.forEach(input => {
                const destination = input.dataset.destination;
                const value = input.value.trim();
                if (value) {
                    formData.pixels[destination] = value;
                }
            });
        }

        function generateConfigSummary() {
            const container = document.getElementById('configSummary');
            
            let summaryHTML = `
                <div class="config-section">
                    <h3 style="margin-bottom: 20px; color: #202124;">Configuration Summary</h3>
                    <div class="input-group">
                        <strong>Tracking Goal:</strong> ${formData.trackingGoal}
                    </div>
                    <div class="input-group">
                        <strong>Selected Platforms:</strong> ${formData.destinations.map(d => platformRequirements[d].name).join(', ')}
                    </div>
                    <div class="input-group">
                        <strong>Platform IDs:</strong>
                        <ul style="margin-top: 8px; padding-left: 20px;">
                            ${Object.entries(formData.pixels).map(([platform, id]) => 
                                `<li>${platformRequirements[platform].name}: ${id}</li>`
                            ).join('')}
                        </ul>
                    </div>
                </div>
            `;

            container.innerHTML = summaryHTML;
        }

        function nextStep() {
            if (currentStep === 3) {
                collectIdData();
            }
            if (currentStep === 4) {
                return; // Don't auto-advance from step 4, user must click create
            }

            const currentStepEl = document.getElementById(`step${currentStep}`);
            const currentCircle = document.getElementById(`circle${currentStep}`);
            const currentLabel = document.getElementById(`label${currentStep}`);

            // Mark current step as completed
            currentStepEl.classList.remove('active');
            currentCircle.classList.remove('active');
            currentCircle.classList.add('completed');
            currentLabel.classList.remove('active');

            currentStep++;

            // Special handling for step 3
            if (currentStep === 3) {
                generateIdInputs();
            }

            // Special handling for step 4
            if (currentStep === 4) {
                generateConfigSummary();
            }

            // Show new step
            const nextStepEl = document.getElementById(`step${currentStep}`);
            const nextCircle = document.getElementById(`circle${currentStep}`);
            const nextLabel = document.getElementById(`label${currentStep}`);

            nextStepEl.classList.add('active');
            nextCircle.classList.add('active');
            nextLabel.classList.add('active');

            updateProgressBar();
        }

        function prevStep() {
            if (currentStep <= 1) return;

            const currentStepEl = document.getElementById(`step${currentStep}`);
            const currentCircle = document.getElementById(`circle${currentStep}`);
            const currentLabel = document.getElementById(`label${currentStep}`);

            currentStepEl.classList.remove('active');
            currentCircle.classList.remove('active');
            currentLabel.classList.remove('active');

            currentStep--;

            const prevStepEl = document.getElementById(`step${currentStep}`);
            const prevCircle = document.getElementById(`circle${currentStep}`);
            const prevLabel = document.getElementById(`label${currentStep}`);

            prevStepEl.classList.add('active');
            prevCircle.classList.remove('completed');
            prevCircle.classList.add('active');
            prevLabel.classList.add('active');

            updateProgressBar();
        }

        function updateProgressBar() {
            const progressFill = document.getElementById('progressFill');
            const progress = ((currentStep - 1) / 4) * 100;
            progressFill.style.width = `${progress}%`;
        }

        async function createConfiguration() {
            // Move to step 5 and show loading
            const currentStepEl = document.getElementById(`step${currentStep}`);
            const currentCircle = document.getElementById(`circle${currentStep}`);
            const currentLabel = document.getElementById(`label${currentStep}`);

            currentStepEl.classList.remove('active');
            currentCircle.classList.remove('active');
            currentCircle.classList.add('completed');
            currentLabel.classList.remove('active');

            currentStep = 5;

            const nextStepEl = document.getElementById(`step${currentStep}`);
            const nextCircle = document.getElementById(`circle${currentStep}`);
            const nextLabel = document.getElementById(`label${currentStep}`);

            nextStepEl.classList.add('active');
            nextCircle.classList.add('active');
            nextLabel.classList.add('active');

            updateProgressBar();

            // Show loading state
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successContent').style.display = 'none';

            try {
                const response = await fetch('http://localhost:8080/configure', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        destinations: formData.destinations,
                        pixels: formData.pixels
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `API Error: ${response.status}`);
                }

                configResponse = await response.json();
                showSuccessState();

            } catch (error) {
                console.error('Configuration error:', error);
                showErrorState(error.message);
            }
        }

        function showSuccessState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successContent').style.display = 'block';

            // Update the completed circle
            const circle5 = document.getElementById('circle5');
            circle5.classList.remove('active');
            circle5.classList.add('completed');

            // Show preview
            const preview = document.getElementById('configPreview');
            const previewData = {
                message: configResponse.message,
                configuration: configResponse.configuration,
                merged_stats: configResponse.merged_stats,
                pixel_injection: configResponse.pixel_injection
            };
            
            preview.textContent = JSON.stringify(previewData, null, 2);
        }

        function showErrorState(errorMessage) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('successContent').style.display = 'none';
            
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = `Error: ${errorMessage}`;
            errorEl.style.display = 'block';

            // Show retry button
            const retryHTML = `
                <div class="buttons" style="margin-top: 20px;">
                    <button class="btn-secondary" onclick="prevStep()">Back</button>
                    <button class="btn-primary" onclick="createConfiguration()">Retry</button>
                </div>
            `;
            errorEl.insertAdjacentHTML('afterend', retryHTML);
        }

        function downloadJSON() {
            if (!configResponse || !configResponse.output || !configResponse.output.filename) {
                alert('No configuration file available for download');
                return;
            }

            const filename = configResponse.output.filename;
            const downloadUrl = `http://localhost:8080/download/${encodeURIComponent(filename)}`;
            
            // Create temporary anchor for download
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = filename;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function integrateWithGTM() {
            alert('GTM integration functionality will be available soon. Please use the Download JSON option for now.');
        }

        function resetWizard() {
            // Reset all data
            currentStep = 1;
            formData = {
                trackingGoal: '',
                destinations: [],
                pixels: {}
            };
            configResponse = null;

            // Reset UI elements
            document.getElementById('trackingGoal').value = '';
            document.getElementById('step1Next').disabled = true;

            // Uncheck all destinations
            document.querySelectorAll('.destination-card').forEach(card => {
                const checkbox = card.querySelector('input[type="checkbox"]');
                checkbox.checked = false;
                card.classList.remove('selected');
            });

            document.getElementById('step2Next').disabled = true;

            // Clear ID inputs
            document.getElementById('idInputs').innerHTML = '';
            document.getElementById('step3Next').disabled = true;

            // Reset all steps and circles
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                const circle = document.getElementById(`circle${i}`);
                const label = document.getElementById(`label${i}`);

                step.classList.remove('active');
                circle.classList.remove('active', 'completed');
                label.classList.remove('active');

                if (i === 1) {
                    step.classList.add('active');
                    circle.classList.add('active');
                    label.classList.add('active');
                }
            }

            // Reset step 5 content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successContent').style.display = 'none';

            // Remove any retry buttons
            const retryButtons = document.querySelectorAll('#errorMessage + .buttons');
            retryButtons.forEach(btn => btn.remove());

            updateProgressBar();
        }
    </script>
</body>
</html>